<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>David's Fitness</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f; --card: #12121a; --card-border: #1e1e2e;
  --accent: #6c5ce7; --accent2: #00cec9; --red: #ff6b6b; --green: #51cf66;
  --yellow: #ffd43b; --orange: #ff922b; --text: #e4e4e7; --text-dim: #71717a; --text-bright: #fafafa;
  --nav-h: 72px; --safe-bottom: env(safe-area-inset-bottom, 0px);
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh; min-height: 100dvh;
  overflow-x: hidden;
  padding-bottom: calc(var(--nav-h) + var(--safe-bottom) + 12px);
}

/* Pages */
.page { display: none; padding: 16px 16px 24px; max-width: 600px; margin: 0 auto; }
.page.active { display: block; }

/* Header */
.page-header {
  text-align: center; padding: 24px 0 16px;
}
.page-header h1 {
  font-size: 1.4rem; font-weight: 800;
  background: linear-gradient(135deg, #6c5ce7, #00cec9);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.page-header .sub { color: var(--text-dim); font-size: 0.8rem; margin-top: 4px; }

/* Target pills */
.targets { display: flex; gap: 8px; margin: 12px 0 16px; flex-wrap: wrap; justify-content: center; }
.target-pill {
  background: rgba(255,255,255,0.05); border: 1px solid var(--card-border);
  border-radius: 10px; padding: 8px 14px; font-size: 0.75rem; text-align: center; flex: 1; min-width: 90px;
}
.target-pill .label { color: var(--text-dim); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; }
.target-pill .value { font-weight: 700; font-size: 0.9rem; color: var(--text-bright); margin-top: 2px; }

/* Stat grid */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.stat-card {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: 14px; padding: 16px; text-align: center;
}
.stat-card .val { font-size: 1.6rem; font-weight: 800; }
.stat-card .lbl { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
.stat-card.green .val { color: var(--green); }
.stat-card.red .val { color: var(--red); }
.stat-card.yellow .val { color: var(--yellow); }
.stat-card.accent .val { color: var(--accent); }

/* Cards */
.card {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: 14px; padding: 16px; margin-bottom: 12px;
}
.card-title {
  font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.2px;
  color: var(--text-dim); margin-bottom: 12px; font-weight: 600;
}

/* Progress */
.progress-bar-bg { height: 10px; background: rgba(255,255,255,0.06); border-radius: 5px; overflow: hidden; }
.progress-bar-fill { height: 100%; border-radius: 5px; background: linear-gradient(90deg, var(--accent), var(--accent2)); }
.progress-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; flex-wrap: wrap; gap: 4px; }
.progress-row span { color: var(--text-dim); }
.progress-row strong { color: var(--text-bright); }
.progress-pct { text-align: right; font-size: 1.3rem; font-weight: 800; color: var(--accent2); margin-bottom: 6px; }

/* Chart */
.chart-wrap { height: 200px; position: relative; }

/* Table */
.log-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
.log-table th {
  text-align: left; padding: 8px 6px; color: var(--text-dim); font-size: 0.65rem;
  text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--card-border);
}
.log-table td { padding: 8px 6px; border-bottom: 1px solid rgba(255,255,255,0.03); }
.badge {
  display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600;
}
.badge.over { background: rgba(255,107,107,0.15); color: var(--red); }
.badge.under { background: rgba(81,207,102,0.15); color: var(--green); }

/* Roadmap */
.roadmap-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
.roadmap-item:last-child { border-bottom: none; }
.rm-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--card-border); flex-shrink: 0; }
.roadmap-item.now .rm-dot { background: var(--accent2); box-shadow: 0 0 10px rgba(0,206,201,0.5); animation: pulse 2s infinite; }
.roadmap-item.goal .rm-dot { background: var(--green); box-shadow: 0 0 10px rgba(81,207,102,0.4); }
.rm-info { flex: 1; }
.rm-info .wk { font-weight: 700; font-size: 0.85rem; }
.rm-info .dt { color: var(--text-dim); font-size: 0.75rem; }
.rm-ms { color: var(--text-dim); font-size: 0.75rem; font-style: italic; }
@keyframes pulse { 0%,100% { box-shadow: 0 0 10px rgba(0,206,201,0.4); } 50% { box-shadow: 0 0 18px rgba(0,206,201,0.7); } }

/* ============ UPLOAD PAGE ============ */
.upload-zone {
  border: 2px dashed var(--card-border); border-radius: 16px;
  padding: 40px 20px; text-align: center; cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  margin-bottom: 16px;
}
.upload-zone:active { border-color: var(--accent2); background: rgba(0,206,201,0.05); }
.upload-zone .icon { font-size: 3rem; margin-bottom: 12px; }
.upload-zone .txt { color: var(--text-dim); font-size: 0.9rem; }
.upload-zone .hint { color: var(--text-dim); font-size: 0.7rem; margin-top: 8px; opacity: 0.6; }

.preview-area { display: none; margin-bottom: 16px; }
.preview-area.show { display: block; }
.preview-area img { width: 100%; border-radius: 12px; margin-bottom: 12px; }
.preview-area .analyzing {
  text-align: center; padding: 20px; color: var(--accent2); font-size: 0.9rem;
}
.preview-area .result {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: 12px; padding: 16px; font-size: 0.88rem; line-height: 1.6;
}
.preview-area .result h3 { color: var(--accent2); font-size: 0.9rem; margin-bottom: 8px; }

.btn {
  width: 100%; padding: 14px; border: none; border-radius: 12px;
  font-family: inherit; font-size: 0.95rem; font-weight: 700;
  cursor: pointer; transition: transform 0.1s, opacity 0.2s;
}
.btn:active { transform: scale(0.97); }
.btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #fff; }
.btn-secondary { background: rgba(255,255,255,0.08); color: var(--text); margin-top: 8px; }
.btn:disabled { opacity: 0.5; }

/* ============ ASK PAGE ============ */
.chat-messages {
  min-height: 300px; max-height: 60vh; overflow-y: auto;
  display: flex; flex-direction: column; gap: 10px;
  margin-bottom: 16px; padding: 4px;
}
.chat-msg {
  max-width: 85%; padding: 12px 16px; border-radius: 16px;
  font-size: 0.88rem; line-height: 1.5; word-wrap: break-word;
}
.chat-msg.user {
  align-self: flex-end; background: var(--accent); color: #fff;
  border-bottom-right-radius: 4px;
}
.chat-msg.ai {
  align-self: flex-start; background: var(--card); border: 1px solid var(--card-border);
  border-bottom-left-radius: 4px;
}
.chat-msg.ai .thinking { color: var(--accent2); font-style: italic; }
.chat-input-row {
  display: flex; gap: 8px; position: sticky; bottom: calc(var(--nav-h) + var(--safe-bottom) + 16px);
  background: var(--bg); padding: 8px 0;
}
.chat-input {
  flex: 1; background: var(--card); border: 1px solid var(--card-border);
  border-radius: 12px; padding: 12px 16px; color: var(--text);
  font-family: inherit; font-size: 0.9rem; outline: none; resize: none;
}
.chat-input::placeholder { color: var(--text-dim); }
.chat-send {
  width: 48px; height: 48px; border-radius: 12px; border: none;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff; font-size: 1.2rem; cursor: pointer; flex-shrink: 0;
}

/* Quick suggestion chips */
.chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
.chip {
  background: rgba(255,255,255,0.06); border: 1px solid var(--card-border);
  border-radius: 20px; padding: 8px 14px; font-size: 0.78rem; color: var(--text);
  cursor: pointer; transition: background 0.2s;
}
.chip:active { background: rgba(108,92,231,0.2); }

/* ============ WEIGHT PAGE ============ */
.weight-input-group { text-align: center; margin: 20px 0; }
.weight-input-group input {
  background: transparent; border: none; color: var(--text-bright);
  font-size: 3rem; font-weight: 800; text-align: center; width: 160px;
  font-family: inherit; outline: none;
  border-bottom: 2px solid var(--card-border);
}
.weight-input-group input:focus { border-bottom-color: var(--accent2); }
.weight-input-group .unit { color: var(--text-dim); font-size: 1rem; margin-left: 4px; }

/* ============ BOTTOM NAV ============ */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: calc(var(--nav-h) + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background: rgba(12,12,18,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--card-border);
  display: flex; align-items: center; justify-content: space-around;
  z-index: 100;
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 8px 16px; cursor: pointer; -webkit-tap-highlight-color: transparent;
  transition: color 0.2s;
  color: var(--text-dim); font-size: 0.6rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;
}
.nav-item .icon { font-size: 1.4rem; }
.nav-item.active { color: var(--accent2); }

/* Center upload button */
.nav-upload {
  width: 56px; height: 56px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.6rem; color: #fff; cursor: pointer;
  margin-top: -20px; box-shadow: 0 4px 20px rgba(108,92,231,0.4);
  transition: transform 0.15s;
}
.nav-upload:active { transform: scale(0.9); }

/* Loading spinner */
.spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--card-border); border-top-color: var(--accent2); border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.loading-page { text-align: center; padding: 60px 20px; color: var(--text-dim); }

/* Today's intake bar */
.today-bar {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: 14px; padding: 14px 16px; margin-bottom: 12px;
}
.today-row { display: flex; justify-content: space-between; align-items: center; }
.today-row .label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
.today-row .val { font-size: 1.1rem; font-weight: 700; }
.today-row .val.good { color: var(--green); }
.today-row .val.warn { color: var(--yellow); }
.today-row .val.bad { color: var(--red); }
.today-mini-bar { height: 4px; background: rgba(255,255,255,0.06); border-radius: 2px; margin-top: 8px; overflow: hidden; }
.today-mini-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }
</style>
</head>
<body>

<!-- ===== DASHBOARD PAGE ===== -->
<div class="page active" id="pg-dash">
  <div class="page-header">
    <h1>üèãÔ∏è David's Fitness</h1>
    <div class="sub">Body Recomposition ‚Äî Feb 2026</div>
  </div>
  <div class="targets">
    <div class="target-pill"><div class="label">Weight</div><div class="value">72.4‚Üí68.6</div></div>
    <div class="target-pill"><div class="label">Body Fat</div><div class="value">18.5‚Üí14%</div></div>
    <div class="target-pill"><div class="label">Timeline</div><div class="value">8 Weeks</div></div>
  </div>
  <div id="todayBar"></div>
  <div id="dashStats" class="stat-grid"></div>
  <div class="card"><div class="card-title">üìä Calories</div><div class="chart-wrap"><canvas id="calChart"></canvas></div></div>
  <div class="card"><div class="card-title">ü•© Protein</div><div class="chart-wrap"><canvas id="protChart"></canvas></div></div>
  <div class="card"><div class="card-title">üìã Daily Log</div><table class="log-table"><thead><tr><th>Date</th><th>Cal</th><th>Prot</th><th>vs Target</th></tr></thead><tbody id="logBody"></tbody></table></div>
  <div class="card">
    <div class="card-title">üéØ Roadmap</div>
    <div id="roadmap"></div>
  </div>
  <div style="text-align:center;padding:16px 0 8px;color:var(--text-dim);font-size:0.65rem;">
    Live from Google Sheets ¬∑ <span id="updated"></span> ¬∑ Tracked by Abi ‚ö°üß†
  </div>
</div>

<!-- ===== UPLOAD PAGE ===== -->
<div class="page" id="pg-upload">
  <div class="page-header"><h1>üì∏ Scan Food</h1><div class="sub">Take a photo and AI will estimate calories</div></div>
  <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
    <div class="icon">üì∑</div>
    <div class="txt">Tap to take photo or choose from gallery</div>
    <div class="hint">AI will analyze and estimate calories & macros</div>
  </div>
  <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none">
  <div class="preview-area" id="previewArea">
    <img id="previewImg" src="" alt="Food photo">
    <div class="analyzing" id="analyzingMsg"><span class="spinner"></span> Analyzing with AI...</div>
    <div class="result" id="resultBox" style="display:none"></div>
    <button class="btn btn-primary" id="logBtn" style="display:none;margin-top:12px" onclick="logToSheet()">‚úÖ Log This Meal</button>
    <button class="btn btn-secondary" onclick="resetUpload()">üì∑ Scan Another</button>
  </div>
</div>

<!-- ===== ASK PAGE ===== -->
<div class="page" id="pg-ask">
  <div class="page-header"><h1>üí¨ Ask Abi</h1><div class="sub">Calorie questions, meal ideas, recommendations</div></div>
  <div class="chips">
    <div class="chip" onclick="askQ('What should I eat for dinner to hit my protein target?')">üçó Dinner ideas</div>
    <div class="chip" onclick="askQ('How am I doing this week?')">üìä Weekly check</div>
    <div class="chip" onclick="askQ('High protein low cal snack ideas')">ü•ú Snack ideas</div>
    <div class="chip" onclick="askQ('Am I on track for my 14% BF goal?')">üéØ Progress check</div>
  </div>
  <div class="chat-messages" id="chatMsgs">
    <div class="chat-msg ai">Hey! Ask me anything about your diet, calories, meal ideas, or progress. I'll check your data and give you advice üí™</div>
  </div>
  <div class="chat-input-row">
    <textarea class="chat-input" id="chatInput" rows="1" placeholder="Ask about calories, meals, progress..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
    <button class="chat-send" onclick="sendChat()">‚Üí</button>
  </div>
</div>

<!-- ===== WEIGHT PAGE ===== -->
<div class="page" id="pg-weight">
  <div class="page-header"><h1>‚öñÔ∏è Log Weight</h1><div class="sub">Track your progress</div></div>
  <div class="weight-input-group">
    <input type="number" id="weightInput" value="72.4" step="0.1" min="50" max="150"><span class="unit">kg</span>
  </div>
  <button class="btn btn-primary" onclick="logWeight()">Save Weight</button>
  <div class="card" style="margin-top:20px">
    <div class="card-title">üìà Weight History</div>
    <div class="chart-wrap"><canvas id="weightChart"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">üéØ Roadmap</div>
    <div id="roadmap2"></div>
  </div>
</div>

<!-- ===== BOTTOM NAV ===== -->
<nav class="bottom-nav">
  <div class="nav-item active" data-page="pg-dash"><div class="icon">üìä</div>Dashboard</div>
  <div class="nav-item" data-page="pg-ask"><div class="icon">üí¨</div>Ask</div>
  <div class="nav-upload" data-page="pg-upload">üì∏</div>
  <div class="nav-item" data-page="pg-weight"><div class="icon">‚öñÔ∏è</div>Weight</div>
  <div class="nav-item" onclick="window.open('https://docs.google.com/spreadsheets/d/1j17rcBXVck-LHO1P0vpA-2cp1Owp44dYlYpHcQvEJmE','_blank')"><div class="icon">üìã</div>Sheet</div>
</nav>

<script>
const SHEET_ID = '1j17rcBXVck-LHO1P0vpA-2cp1Owp44dYlYpHcQvEJmE';
const CAL_TARGET = 1750, PROT_TARGET = 145;
const WA_NUMBER = '60169120952';
let API_URL = '';
const GIST_RAW = 'https://gist.githubusercontent.com/abigailmini/1a10bef17254252fb6af2c61f2db6fc0/raw/api-url.txt';
let dailyData = [], lastAnalysis = null;

// ===== NAV =====
document.querySelectorAll('.nav-item, .nav-upload').forEach(el => {
  const page = el.dataset.page;
  if (!page) return;
  el.addEventListener('click', () => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(page).classList.add('active');
    document.querySelectorAll('.nav-item, .nav-upload').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    window.scrollTo(0, 0);
  });
});

// ===== DATA FETCH =====
async function fetchData() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Sheet1`;
  const resp = await fetch(url);
  const text = await resp.text();
  const jsonStr = text.match(/google\.visualization\.Query\.setResponse\((.+)\)/s)?.[1];
  if (!jsonStr) throw new Error('Parse failed');
  const json = JSON.parse(jsonStr);
  const meals = [];
  for (const row of json.table.rows) {
    const c = row.c;
    if (!c[0]?.v) continue;
    let d = String(c[0].f || c[0].v);
    if (d.startsWith('Date(')) {
      const p = d.match(/Date\((\d+),(\d+),(\d+)\)/);
      if (p) d = new Date(+p[1], +p[2], +p[3]).toISOString().split('T')[0];
    }
    meals.push({ date: d, meal: c[1]?.v||'', food: c[2]?.v||'', cal: Number(c[3]?.v)||0, prot: Number(c[4]?.v)||0 });
  }
  const byDate = {};
  for (const m of meals) {
    if (!byDate[m.date]) byDate[m.date] = { date: m.date, cal: 0, prot: 0, meals: [] };
    byDate[m.date].cal += m.cal;
    byDate[m.date].prot += m.prot;
    byDate[m.date].meals.push(m);
  }
  return Object.values(byDate).sort((a, b) => a.date.localeCompare(b.date));
}

function shortDate(d) {
  try {
    const dt = new Date(d + 'T00:00:00');
    return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  } catch(e) { return d; }
}

// ===== RENDER DASHBOARD =====
function renderDash(data) {
  dailyData = data;
  const avg = (arr, key) => arr.length ? Math.round(arr.reduce((s,d) => s + d[key], 0) / arr.length) : 0;
  const avgCal = avg(data, 'cal'), avgProt = avg(data, 'prot');
  const calHit = data.length ? Math.round(data.filter(d => d.cal <= CAL_TARGET && d.cal > 0).length / data.length * 100) : 0;
  const protHit = data.length ? Math.round(data.filter(d => d.prot >= PROT_TARGET).length / data.length * 100) : 0;

  // Today bar
  const today = new Date().toISOString().split('T')[0];
  const todayData = data.find(d => d.date === today);
  const tCal = todayData?.cal || 0, tProt = todayData?.prot || 0;
  const calPct = Math.min(100, Math.round(tCal / CAL_TARGET * 100));
  const protPct = Math.min(100, Math.round(tProt / PROT_TARGET * 100));
  document.getElementById('todayBar').innerHTML = `
    <div class="today-bar">
      <div style="font-weight:700;font-size:0.85rem;margin-bottom:10px">üìç Today</div>
      <div class="today-row"><span class="label">Calories</span><span class="val ${tCal > CAL_TARGET ? 'bad' : tCal > CAL_TARGET*0.8 ? 'warn' : 'good'}">${tCal.toLocaleString()} / ${CAL_TARGET.toLocaleString()}</span></div>
      <div class="today-mini-bar"><div class="today-mini-fill" style="width:${calPct}%;background:${tCal>CAL_TARGET?'var(--red)':'var(--accent2)'}"></div></div>
      <div class="today-row" style="margin-top:10px"><span class="label">Protein</span><span class="val ${tProt >= PROT_TARGET ? 'good' : 'bad'}">${tProt}g / ${PROT_TARGET}g</span></div>
      <div class="today-mini-bar"><div class="today-mini-fill" style="width:${protPct}%;background:${tProt>=PROT_TARGET?'var(--green)':'var(--orange)'}"></div></div>
    </div>`;

  // Stats
  document.getElementById('dashStats').innerHTML = `
    <div class="stat-card ${avgCal > CAL_TARGET ? 'yellow' : 'green'}"><div class="val">${avgCal.toLocaleString()}</div><div class="lbl">Avg Cal</div></div>
    <div class="stat-card ${avgProt < PROT_TARGET ? 'red' : 'green'}"><div class="val">${avgProt}g</div><div class="lbl">Avg Protein</div></div>
    <div class="stat-card ${calHit >= 50 ? 'green' : 'accent'}"><div class="val">${calHit}%</div><div class="lbl">Cal Hit</div></div>
    <div class="stat-card ${protHit >= 50 ? 'green' : 'red'}"><div class="val">${protHit}%</div><div class="lbl">Prot Hit</div></div>`;

  // Table
  const tbody = document.getElementById('logBody');
  tbody.innerHTML = data.map(d => {
    const cd = d.cal - CAL_TARGET, pd = d.prot - PROT_TARGET;
    return `<tr><td style="font-weight:600">${shortDate(d.date)}</td><td>${d.cal.toLocaleString()}</td><td>${d.prot}g</td>
    <td><span class="badge ${cd>0?'over':'under'}">${cd>0?'+':''}${cd}</span></td></tr>`;
  }).join('');

  // Charts
  Chart.defaults.color = '#71717a';
  Chart.defaults.borderColor = 'rgba(255,255,255,0.04)';
  Chart.defaults.font.family = 'Inter';
  const labels = data.map(d => shortDate(d.date));

  if (window._calChart) window._calChart.destroy();
  if (window._protChart) window._protChart.destroy();

  window._calChart = new Chart(document.getElementById('calChart'), {
    type: 'bar',
    data: { labels, datasets: [
      { label: 'Calories', data: data.map(d=>d.cal), backgroundColor: data.map(d=>d.cal>CAL_TARGET?'rgba(255,107,107,0.7)':'rgba(108,92,231,0.7)'), borderRadius: 5, borderSkipped: false },
      { label: 'Target', data: Array(labels.length).fill(CAL_TARGET), type:'line', borderColor:'rgba(0,206,201,0.7)', borderDash:[5,3], borderWidth:2, pointRadius:0, fill:false }
    ]},
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:false,min:Math.min(800,...data.map(d=>d.cal))-100,grid:{color:'rgba(255,255,255,0.03)'}},x:{grid:{display:false},ticks:{font:{size:10}}}}}
  });

  window._protChart = new Chart(document.getElementById('protChart'), {
    type: 'bar',
    data: { labels, datasets: [
      { label: 'Protein', data: data.map(d=>d.prot), backgroundColor: data.map(d=>d.prot>=PROT_TARGET?'rgba(81,207,102,0.7)':'rgba(255,146,43,0.7)'), borderRadius: 5, borderSkipped: false },
      { label: 'Target', data: Array(labels.length).fill(PROT_TARGET), type:'line', borderColor:'rgba(0,206,201,0.7)', borderDash:[5,3], borderWidth:2, pointRadius:0, fill:false }
    ]},
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:false,min:Math.min(40,...data.map(d=>d.prot))-10,grid:{color:'rgba(255,255,255,0.03)'}},x:{grid:{display:false},ticks:{font:{size:10}}}}}
  });

  // Roadmap
  const roadmapHTML = [
    { wk:'Week 0 ‚Äî Now', dt:'72.4 kg ¬∑ 18.5% BF', ms:'Starting point', cls:'now' },
    { wk:'Week 2', dt:'71.4 kg ¬∑ 17.5% BF', ms:'First visible change', cls:'' },
    { wk:'Week 4', dt:'70.4 kg ¬∑ 16.5% BF', ms:'Clothes fit looser', cls:'' },
    { wk:'Week 6', dt:'69.4 kg ¬∑ 15.5% BF', ms:'Upper abs visible', cls:'' },
    { wk:'Week 8 üèÜ', dt:'68.6 kg ¬∑ 14% BF', ms:'GOAL!', cls:'goal' },
  ].map(r => `<div class="roadmap-item ${r.cls}"><div class="rm-dot"></div><div class="rm-info"><div class="wk">${r.wk}</div><div class="dt">${r.dt}</div></div><div class="rm-ms">${r.ms}</div></div>`).join('');
  document.getElementById('roadmap').innerHTML = roadmapHTML;
  if (document.getElementById('roadmap2')) document.getElementById('roadmap2').innerHTML = roadmapHTML;

  document.getElementById('updated').textContent = new Date().toLocaleString('en-MY', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
}

// ===== UPLOAD / PHOTO SCAN =====
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (ev) => {
    const dataUrl = ev.target.result;
    document.getElementById('previewImg').src = dataUrl;
    document.getElementById('previewArea').classList.add('show');
    document.getElementById('uploadZone').style.display = 'none';
    document.getElementById('analyzingMsg').style.display = 'block';
    document.getElementById('resultBox').style.display = 'none';
    document.getElementById('logBtn').style.display = 'none';

    try {
      const resp = await fetch(`${API_URL}/analyze`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: dataUrl })
      });
      const data = await resp.json();
      document.getElementById('analyzingMsg').style.display = 'none';
      document.getElementById('resultBox').style.display = 'block';

      if (data.ok && data.analysis) {
        const a = data.analysis;
        if (a.raw) {
          document.getElementById('resultBox').innerHTML = `<h3>üìä Analysis</h3><p>${a.raw}</p>`;
        } else {
          lastAnalysis = a;
          const itemsHtml = (a.items||[]).map(i => 
            `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)">
              <span>${i.name}</span><span style="color:var(--accent2)">${i.calories} cal ¬∑ ${i.protein}g P</span>
            </div>`).join('');
          document.getElementById('resultBox').innerHTML = `
            <h3>üìä ${a.meal_name || 'Meal Analysis'}</h3>
            <div style="margin:12px 0">${itemsHtml}</div>
            <div style="background:rgba(0,206,201,0.1);border-radius:10px;padding:12px;margin-top:12px">
              <div style="display:flex;justify-content:space-around;text-align:center">
                <div><div style="font-size:1.3rem;font-weight:800;color:var(--accent2)">${a.total?.calories||0}</div><div style="font-size:0.65rem;color:var(--text-dim)">CALORIES</div></div>
                <div><div style="font-size:1.3rem;font-weight:800;color:var(--green)">${a.total?.protein||0}g</div><div style="font-size:0.65rem;color:var(--text-dim)">PROTEIN</div></div>
                <div><div style="font-size:1.3rem;font-weight:800;color:var(--orange)">${a.total?.carbs||0}g</div><div style="font-size:0.65rem;color:var(--text-dim)">CARBS</div></div>
                <div><div style="font-size:1.3rem;font-weight:800;color:var(--yellow)">${a.total?.fat||0}g</div><div style="font-size:0.65rem;color:var(--text-dim)">FAT</div></div>
              </div>
            </div>
            ${a.confidence ? `<div style="text-align:center;margin-top:8px;font-size:0.7rem;color:var(--text-dim)">Confidence: ${a.confidence}</div>` : ''}
            ${a.notes ? `<div style="margin-top:8px;font-size:0.8rem;color:var(--text-dim);font-style:italic">${a.notes}</div>` : ''}`;
          document.getElementById('logBtn').style.display = 'block';
        }
      } else {
        document.getElementById('resultBox').innerHTML = `<h3>‚ùå Error</h3><p>${data.error || 'Analysis failed'}</p>`;
      }
    } catch(e) {
      document.getElementById('analyzingMsg').style.display = 'none';
      document.getElementById('resultBox').style.display = 'block';
      document.getElementById('resultBox').innerHTML = `<h3>‚ö†Ô∏è API Offline</h3><p>The analysis server isn't reachable. Send the photo to Abi on WhatsApp instead:</p>
        <a href="https://wa.me/${WA_NUMBER}?text=${encodeURIComponent('üì∏ Food photo for calorie scan')}" target="_blank"
           style="display:block;text-align:center;padding:14px;background:linear-gradient(135deg,#25D366,#128C7E);color:#fff;border-radius:12px;text-decoration:none;font-weight:700;margin-top:12px">
          üì± Send to Abi on WhatsApp
        </a>`;
    }
  };
  reader.readAsDataURL(file);
});

function logToSheet() {
  if (!lastAnalysis?.total) return;
  const a = lastAnalysis;
  const waText = encodeURIComponent(`üìù Log meal: ${a.meal_name || 'Meal'} ‚Äî ${a.total.calories} cal, ${a.total.protein}g protein, ${a.total.carbs}g carbs, ${a.total.fat}g fat`);
  window.open(`https://wa.me/${WA_NUMBER}?text=${waText}`, '_blank');
}

function resetUpload() {
  document.getElementById('previewArea').classList.remove('show');
  document.getElementById('uploadZone').style.display = '';
  fileInput.value = '';
}

// ===== ASK / CHAT =====
function addMsg(text, role) {
  const div = document.createElement('div');
  div.className = `chat-msg ${role}`;
  div.innerHTML = text;
  document.getElementById('chatMsgs').appendChild(div);
  div.scrollIntoView({ behavior: 'smooth' });
}

function askQ(q) {
  document.getElementById('chatInput').value = q;
  sendChat();
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const q = input.value.trim();
  if (!q) return;
  input.value = '';

  addMsg(q, 'user');
  addMsg('<span class="thinking"><span class="spinner"></span> Thinking...</span>', 'ai');

  const today = new Date().toISOString().split('T')[0];
  const td = dailyData.find(d => d.date === today);
  const avgCal = dailyData.length ? Math.round(dailyData.reduce((s,d)=>s+d.cal,0)/dailyData.length) : 0;
  const avgProt = dailyData.length ? Math.round(dailyData.reduce((s,d)=>s+d.prot,0)/dailyData.length) : 0;
  
  const context = `User: David. Goals: 1750 cal/day, 145g protein/day, lose fat 18.5%‚Üí14% BF.
Weight: 72.4kg‚Üí68.6kg target. Today (${today}): ${td ? td.cal+' cal, '+td.prot+'g prot' : 'nothing logged'}.
Week avg: ${avgCal} cal, ${avgProt}g prot over ${dailyData.length} days.
High uric acid ‚Äî limit beef, shellfish, beer, organ meats.
Loves: omakase, wagyu, ramen, duck, satay, nasi lemak. Based in KL, Malaysia.`;

  const msgs = document.getElementById('chatMsgs');

  try {
    const resp = await fetch(`${API_URL}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question: q, context })
    });
    const data = await resp.json();
    msgs.removeChild(msgs.lastChild);
    if (data.ok) {
      addMsg(data.reply.replace(/\n/g, '<br>'), 'ai');
    } else {
      addMsg(`‚ùå ${data.error || 'Something went wrong'}`, 'ai');
    }
  } catch(e) {
    msgs.removeChild(msgs.lastChild);
    addMsg(`‚ö†Ô∏è API offline. <a href="https://wa.me/${WA_NUMBER}?text=${encodeURIComponent('üí¨ '+q)}" target="_blank" style="color:var(--accent2)">Ask Abi on WhatsApp instead ‚Üí</a>`, 'ai');
  }
}

// ===== WEIGHT =====
function logWeight() {
  const w = document.getElementById('weightInput').value;
  const waText = encodeURIComponent(`‚öñÔ∏è Weight update: ${w} kg`);
  window.open(`https://wa.me/${WA_NUMBER}?text=${waText}`, '_blank');
}

// ===== INIT =====
(async () => {
  // Fetch API URL from gist (auto-updated when tunnel reconnects)
  try {
    const r = await fetch(GIST_RAW + '?t=' + Date.now());
    API_URL = (await r.text()).trim();
  } catch(e) { console.warn('Could not fetch API URL:', e); }

  try {
    const data = await fetchData();
    renderDash(data);
  } catch(e) {
    document.getElementById('pg-dash').innerHTML = `<div class="loading-page">‚ùå ${e.message}<br><button class="btn btn-primary" style="width:auto;margin-top:16px;padding:10px 24px" onclick="location.reload()">Retry</button></div>`;
  }
})();
</script>
</body>
</html>
