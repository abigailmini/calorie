<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>David's Fitness</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f; --card: #12121a; --card-border: #1e1e2e;
  --accent: #6c5ce7; --accent2: #00cec9; --red: #ff6b6b; --green: #51cf66;
  --yellow: #ffd43b; --orange: #ff922b; --text: #e4e4e7; --text-dim: #71717a; --text-bright: #fafafa;
  --nav-h: 72px; --safe-bottom: env(safe-area-inset-bottom, 0px);
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh; min-height: 100dvh;
  overflow-x: hidden;
  padding-bottom: calc(var(--nav-h) + var(--safe-bottom) + 12px);
}

/* Pages */
.page { display: none; padding: 16px 16px 24px; max-width: 600px; margin: 0 auto; }
.page.active { display: block; }

/* Header */
.page-header {
  text-align: center; padding: 24px 0 16px;
}
.page-header h1 {
  font-size: 1.4rem; font-weight: 800;
  background: linear-gradient(135deg, #6c5ce7, #00cec9);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.page-header .sub { color: var(--text-dim); font-size: 0.8rem; margin-top: 4px; }

/* Target pills */
.targets { display: flex; gap: 8px; margin: 12px 0 16px; flex-wrap: wrap; justify-content: center; }
.target-pill {
  background: rgba(255,255,255,0.05); border: 1px solid var(--card-border);
  border-radius: 10px; padding: 8px 14px; font-size: 0.75rem; text-align: center; flex: 1; min-width: 90px;
}
.target-pill .label { color: var(--text-dim); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; }
.target-pill .value { font-weight: 700; font-size: 0.9rem; color: var(--text-bright); margin-top: 2px; }

/* Stat grid */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.stat-card {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: 14px; padding: 16px; text-align: center;
}
.stat-card .val { font-size: 1.6rem; font-weight: 800; }
.stat-card .lbl { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
.stat-card.green .val { color: var(--green); }
.stat-card.red .val { color: var(--red); }
.stat-card.yellow .val { color: var(--yellow); }
.stat-card.accent .val { color: var(--accent); }

/* Cards */
.card {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: 14px; padding: 16px; margin-bottom: 12px;
}
.card-title {
  font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.2px;
  color: var(--text-dim); margin-bottom: 12px; font-weight: 600;
}

/* Progress */
.progress-bar-bg { height: 10px; background: rgba(255,255,255,0.06); border-radius: 5px; overflow: hidden; }
.progress-bar-fill { height: 100%; border-radius: 5px; background: linear-gradient(90deg, var(--accent), var(--accent2)); }
.progress-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; flex-wrap: wrap; gap: 4px; }
.progress-row span { color: var(--text-dim); }
.progress-row strong { color: var(--text-bright); }
.progress-pct { text-align: right; font-size: 1.3rem; font-weight: 800; color: var(--accent2); margin-bottom: 6px; }

/* Chart */
.chart-wrap { height: 200px; position: relative; }

/* Table */
.log-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
.log-table th {
  text-align: left; padding: 8px 6px; color: var(--text-dim); font-size: 0.65rem;
  text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--card-border);
}
.log-table td { padding: 8px 6px; border-bottom: 1px solid rgba(255,255,255,0.03); }
.badge {
  display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600;
}
.badge.over { background: rgba(255,107,107,0.15); color: var(--red); }
.badge.under { background: rgba(81,207,102,0.15); color: var(--green); }

/* Roadmap */
.roadmap-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
.roadmap-item:last-child { border-bottom: none; }
.rm-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--card-border); flex-shrink: 0; }
.roadmap-item.now .rm-dot { background: var(--accent2); box-shadow: 0 0 10px rgba(0,206,201,0.5); animation: pulse 2s infinite; }
.roadmap-item.goal .rm-dot { background: var(--green); box-shadow: 0 0 10px rgba(81,207,102,0.4); }
.rm-info { flex: 1; }
.rm-info .wk { font-weight: 700; font-size: 0.85rem; }
.rm-info .dt { color: var(--text-dim); font-size: 0.75rem; }
.rm-ms { color: var(--text-dim); font-size: 0.75rem; font-style: italic; }
@keyframes pulse { 0%,100% { box-shadow: 0 0 10px rgba(0,206,201,0.4); } 50% { box-shadow: 0 0 18px rgba(0,206,201,0.7); } }

/* ============ UPLOAD PAGE ============ */
.upload-zone {
  border: 2px dashed var(--card-border); border-radius: 16px;
  padding: 40px 20px; text-align: center; cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  margin-bottom: 16px;
}
.upload-zone:active { border-color: var(--accent2); background: rgba(0,206,201,0.05); }
.upload-zone .icon { font-size: 3rem; margin-bottom: 12px; }
.upload-zone .txt { color: var(--text-dim); font-size: 0.9rem; }
.upload-zone .hint { color: var(--text-dim); font-size: 0.7rem; margin-top: 8px; opacity: 0.6; }

.preview-area { display: none; margin-bottom: 16px; }
.preview-area.show { display: block; }
.preview-area img { width: 100%; border-radius: 12px; margin-bottom: 12px; }
.preview-area .analyzing {
  text-align: center; padding: 20px; color: var(--accent2); font-size: 0.9rem;
}
.preview-area .result {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: 12px; padding: 16px; font-size: 0.88rem; line-height: 1.6;
}
.preview-area .result h3 { color: var(--accent2); font-size: 0.9rem; margin-bottom: 8px; }

.btn {
  width: 100%; padding: 14px; border: none; border-radius: 12px;
  font-family: inherit; font-size: 0.95rem; font-weight: 700;
  cursor: pointer; transition: transform 0.1s, opacity 0.2s;
}
.btn:active { transform: scale(0.97); }
.btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #fff; }
.btn-secondary { background: rgba(255,255,255,0.08); color: var(--text); margin-top: 8px; }
.btn:disabled { opacity: 0.5; }

/* Editable item rows */
.edit-item {
  background: rgba(255,255,255,0.03); border: 1px solid var(--card-border);
  border-radius: 10px; padding: 10px; margin-bottom: 8px;
}
.edit-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.edit-item-name {
  background: transparent; border: none; color: var(--text-bright);
  font-family: inherit; font-size: 0.85rem; font-weight: 600; outline: none;
  flex: 1; padding: 2px 0;
  border-bottom: 1px solid transparent;
}
.edit-item-name:focus { border-bottom-color: var(--accent2); }
.edit-item-del {
  width: 24px; height: 24px; border-radius: 6px; border: none;
  background: rgba(255,107,107,0.15); color: var(--red);
  font-size: 0.8rem; cursor: pointer; flex-shrink: 0; margin-left: 8px;
}
.edit-item-macros { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 5px; }
.macro-field { text-align: center; }
.macro-field label { display: block; font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
.macro-field input {
  width: 100%; background: var(--card); border: 1px solid var(--card-border);
  border-radius: 8px; padding: 6px 4px; color: var(--text-bright);
  font-family: inherit; font-size: 0.85rem; font-weight: 600; text-align: center; outline: none;
}
.macro-field input:focus { border-color: var(--accent2); }

/* ============ ASK PAGE ============ */
.chat-messages {
  min-height: 200px; max-height: calc(100dvh - 280px); overflow-y: auto;
  display: flex; flex-direction: column; gap: 10px;
  margin-bottom: 8px; padding: 4px;
}
.chat-msg {
  max-width: 85%; padding: 12px 16px; border-radius: 16px;
  font-size: 0.88rem; line-height: 1.5; word-wrap: break-word;
}
.chat-msg.user {
  align-self: flex-end; background: var(--accent); color: #fff;
  border-bottom-right-radius: 4px;
}
.chat-msg.ai {
  align-self: flex-start; background: var(--card); border: 1px solid var(--card-border);
  border-bottom-left-radius: 4px;
}
.chat-msg.ai .thinking { color: var(--accent2); font-style: italic; }
.chat-input-row {
  display: flex; gap: 8px; position: fixed; bottom: calc(var(--nav-h) + var(--safe-bottom));
  left: 0; right: 0; padding: 10px 16px; background: var(--bg);
  border-top: 1px solid var(--card-border); max-width: 600px; margin: 0 auto;
}
.chat-input {
  flex: 1; background: var(--card); border: 1px solid var(--card-border);
  border-radius: 12px; padding: 12px 16px; color: var(--text);
  font-family: inherit; font-size: 0.9rem; outline: none; resize: none;
}
.chat-input::placeholder { color: var(--text-dim); }
.chat-send {
  width: 44px; height: 44px; border-radius: 12px; border: none;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff; font-size: 1.2rem; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
}

/* Quick suggestion chips */
.chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
.chip {
  background: rgba(255,255,255,0.06); border: 1px solid var(--card-border);
  border-radius: 20px; padding: 8px 14px; font-size: 0.78rem; color: var(--text);
  cursor: pointer; transition: background 0.2s;
}
.chip:active { background: rgba(108,92,231,0.2); }

/* ============ WEIGHT PAGE ============ */
.weight-input-group { text-align: center; margin: 20px 0; }
.weight-input-group input {
  background: transparent; border: none; color: var(--text-bright);
  font-size: 3rem; font-weight: 800; text-align: center; width: 160px;
  font-family: inherit; outline: none;
  border-bottom: 2px solid var(--card-border);
}
.weight-input-group input:focus { border-bottom-color: var(--accent2); }
.weight-input-group .unit { color: var(--text-dim); font-size: 1rem; margin-left: 4px; }

/* ============ BOTTOM NAV ============ */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: calc(var(--nav-h) + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background: rgba(12,12,18,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--card-border);
  display: flex; align-items: center; justify-content: space-around;
  z-index: 100;
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 8px 16px; cursor: pointer; -webkit-tap-highlight-color: transparent;
  transition: color 0.2s;
  color: var(--text-dim); font-size: 0.6rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;
}
.nav-item .icon { font-size: 1.4rem; line-height: 0; }
.nav-item.active { color: var(--accent2); }

/* Center upload button */
.nav-upload {
  width: 56px; height: 56px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.6rem; color: #fff; cursor: pointer;
  margin-top: -20px; box-shadow: 0 4px 20px rgba(108,92,231,0.4);
  transition: transform 0.15s;
}
.nav-upload:active { transform: scale(0.9); }

/* Loading spinner */
.spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--card-border); border-top-color: var(--accent2); border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.loading-page { text-align: center; padding: 60px 20px; color: var(--text-dim); }

/* Today's intake bar */
.today-bar {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: 14px; padding: 14px 16px; margin-bottom: 12px;
}
.today-row { display: flex; justify-content: space-between; align-items: center; }
.today-row .label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
.today-row .val { font-size: 1.1rem; font-weight: 700; }
.today-row .val.good { color: var(--green); }
.today-row .val.warn { color: var(--yellow); }
.today-row .val.bad { color: var(--red); }
.today-mini-bar { height: 4px; background: rgba(255,255,255,0.06); border-radius: 2px; margin-top: 8px; overflow: hidden; }
.today-mini-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }
</style>
</head>
<body>

<!-- ===== DASHBOARD PAGE ===== -->
<div class="page active" id="pg-dash">
  <div class="page-header">
    <h1>üèãÔ∏è David's Fitness</h1>
    <div class="sub">Body Recomposition ‚Äî Feb 2026</div>
  </div>
  <div class="targets">
    <div class="target-pill"><div class="label">Weight</div><div class="value">72.4‚Üí68.6</div></div>
    <div class="target-pill"><div class="label">Body Fat</div><div class="value">18.5‚Üí14%</div></div>
    <div class="target-pill"><div class="label">Timeline</div><div class="value">8 Weeks</div></div>
  </div>
  <div id="todayBar"></div>
  <div id="dashStats" class="stat-grid"></div>
  <div class="card"><div class="card-title">üìä Calories</div><div class="chart-wrap"><canvas id="calChart"></canvas></div></div>
  <div class="card"><div class="card-title">ü•© Protein</div><div class="chart-wrap"><canvas id="protChart"></canvas></div></div>
  <div class="card"><div class="card-title">üìã Daily Log</div><table class="log-table"><thead><tr><th>Date</th><th>Cal</th><th>Prot</th><th>vs Target</th></tr></thead><tbody id="logBody"></tbody></table></div>
  <div class="card">
    <div class="card-title">üéØ Roadmap</div>
    <div id="roadmap"></div>
  </div>
  <div style="text-align:center;padding:16px 0 8px;color:var(--text-dim);font-size:0.65rem;">
    Live from Google Sheets ¬∑ <span id="updated"></span> ¬∑ Tracked by Abi ‚ö°üß†
  </div>
</div>

<!-- ===== UPLOAD PAGE ===== -->
<div class="page" id="pg-upload">
  <div class="page-header"><h1>Log Food</h1><div class="sub">Scan a photo or type what you ate</div></div>
  <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()" style="display:none">
  </div>
  <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none">
  <input type="file" id="fileInputGallery" accept="image/*" style="display:none">
  <div id="uploadBtns" style="display:flex;flex-direction:column;gap:10px;padding-top:20px">
    <div style="text-align:center;margin-bottom:12px"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üì∏ Take Photo</button>
    <button class="btn btn-secondary" onclick="document.getElementById('fileInputGallery').click()">üñºÔ∏è Choose from Gallery</button>
    <div style="display:flex;align-items:center;gap:12px;margin:4px 0"><div style="flex:1;height:1px;background:var(--card-border)"></div><span style="color:var(--text-dim);font-size:0.75rem">OR</span><div style="flex:1;height:1px;background:var(--card-border)"></div></div>
    <button class="btn btn-secondary" onclick="startManualEntry()" style="border-color:var(--accent)">‚úèÔ∏è Type What You Ate</button>
    <!-- Quick text input for AI parsing -->
    <div id="manualEntryBox" style="display:none">
      <div class="card" style="margin-top:8px">
        <textarea id="manualFoodInput" placeholder="e.g. chicken rice, teh tarik, 2 eggs&#10;or: nasi lemak 1 pack, iced milo" style="width:100%;min-height:80px;background:var(--bg);border:1px solid var(--card-border);border-radius:8px;color:var(--text);padding:12px;font-size:0.9rem;font-family:inherit;resize:vertical"></textarea>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-primary" style="flex:2" onclick="analyzeManualText()">üß† Estimate with AI</button>
          <button class="btn btn-secondary" style="flex:1;margin:0" onclick="skipAIManual()">Skip AI</button>
        </div>
        <div style="color:var(--text-dim);font-size:0.7rem;margin-top:6px;text-align:center">AI estimates calories, or skip to enter manually</div>
      </div>
    </div>
  </div>
  <div class="preview-area" id="previewArea">
    <img id="previewImg" src="" alt="Food photo">
    <div class="analyzing" id="analyzingMsg"><span class="spinner"></span> Analyzing with AI...</div>
    <div class="result" id="resultBox" style="display:none"></div>
    <!-- Editable items list -->
    <div id="editSection" style="display:none">
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div class="card-title" style="margin:0">Edit Items</div>
          <button class="chip" onclick="addItem()" style="margin:0;font-size:0.7rem">+ Add Item</button>
        </div>
        <div id="itemsList"></div>
      </div>
      <div id="recoBox" class="card" style="margin-top:10px;display:none;border-color:rgba(0,206,201,0.3);background:rgba(0,206,201,0.05)">
        <div class="card-title" style="color:var(--accent2)">üí° Recommendation</div>
        <div id="recoText" style="font-size:0.85rem;line-height:1.5"></div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="card-title">Meal Total</div>
        <div style="display:flex;justify-content:space-around;text-align:center" id="editTotals"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-primary" style="flex:2" onclick="logToSheet()">‚úÖ Log Meal</button>
        <button class="btn btn-secondary" style="flex:1;margin:0" onclick="resetUpload()">Retake</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== ASK PAGE ===== -->
<div class="page" id="pg-ask">
  <div class="page-header"><h1>Ask Abi</h1><div class="sub">Powered by AI ¬∑ Calorie & fitness advice</div></div>
  <div class="chips" id="chipsSec">
    <div class="chip" onclick="askQ('What should I eat for dinner to hit my protein target?')">üçó Dinner ideas</div>
    <div class="chip" onclick="askQ('How am I doing this week?')">üìä Weekly check</div>
    <div class="chip" onclick="askQ('High protein low cal snack ideas')">ü•ú Snack ideas</div>
    <div class="chip" onclick="askQ('Am I on track for my 14% BF goal?')">üéØ Progress</div>
  </div>
  <div class="chat-messages" id="chatMsgs">
    <div class="chat-msg ai">Hey! Ask me anything about your diet, calories, meal ideas, or progress üí™</div>
  </div>
  <div class="chat-input-row" id="chatBar">
    <textarea class="chat-input" id="chatInput" rows="1" placeholder="Ask anything..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,80)+'px'"></textarea>
    <button class="chat-send" onclick="sendChat()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<!-- ===== WEIGHT PAGE ===== -->
<div class="page" id="pg-weight">
  <div class="page-header"><h1>Log Weight</h1><div class="sub">Track your body composition</div></div>
  <div class="weight-input-group">
    <input type="number" id="weightInput" value="72.4" step="0.1" min="50" max="150"><span class="unit">kg</span>
  </div>
  <button class="btn btn-primary" onclick="logWeight()">Save Weight</button>
  <div class="card" style="margin-top:20px">
    <div class="card-title">üìà Weight History</div>
    <div class="chart-wrap"><canvas id="weightChart"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">üéØ Roadmap</div>
    <div id="roadmap2"></div>
  </div>
</div>

<!-- ===== BOTTOM NAV ===== -->
<nav class="bottom-nav">
  <div class="nav-item active" data-page="pg-dash"><div class="icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></div>Home</div>
  <div class="nav-item" data-page="pg-ask"><div class="icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>Ask</div>
  <div class="nav-upload" data-page="pg-upload"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
  <div class="nav-item" data-page="pg-weight"><div class="icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/><path d="M12 6v6l4 2"/></svg></div>Weight</div>
  <div class="nav-item" onclick="window.open('https://docs.google.com/spreadsheets/d/1j17rcBXVck-LHO1P0vpA-2cp1Owp44dYlYpHcQvEJmE','_blank')"><div class="icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>Sheet</div>
</nav>

<script>
const SHEET_ID = '1j17rcBXVck-LHO1P0vpA-2cp1Owp44dYlYpHcQvEJmE';
const CAL_TARGET = 1750, PROT_TARGET = 145;
const WA_NUMBER = '60169120952';
let API_URL = '';
const GIST_RAW = 'https://gist.githubusercontent.com/abigailmini/1a10bef17254252fb6af2c61f2db6fc0/raw/api-url.txt';

// API fetch helper with serveo bypass header
function apiFetch(path, body, timeoutMs = 30000) {
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), timeoutMs);
  return fetch(`${API_URL}${path}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Bypass-Tunnel-Reminder': 'true' },
    body: JSON.stringify(body),
    signal: ctrl.signal
  }).finally(() => clearTimeout(timer));
}
let dailyData = [], lastAnalysis = null;

// ===== NAV =====
document.querySelectorAll('.nav-item, .nav-upload').forEach(el => {
  const page = el.dataset.page;
  if (!page) return;
  el.addEventListener('click', () => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(page).classList.add('active');
    document.querySelectorAll('.nav-item, .nav-upload').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    window.scrollTo(0, 0);
    // Reset upload page state when navigating to it
    if (page === 'pg-upload' && !document.getElementById('previewArea').classList.contains('show')) {
      document.getElementById('uploadBtns').style.display = 'flex';
    }
  });
});

// ===== DATA FETCH =====
async function fetchData() {
  // Only fetch columns A-G to avoid junk data in other columns
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Sheet1&tq=${encodeURIComponent('SELECT A,B,C,D,E,F,G WHERE A IS NOT NULL')}`;
  const resp = await fetch(url);
  const text = await resp.text();
  const jsonStr = text.match(/google\.visualization\.Query\.setResponse\((.+)\)/s)?.[1];
  if (!jsonStr) throw new Error('Parse failed');
  const json = JSON.parse(jsonStr);
  const meals = [];
  for (const row of json.table.rows) {
    const c = row.c;
    if (!c[0]) continue;
    let d = '';
    // Handle Google Sheets date format
    const raw = String(c[0].v || '');
    const fmt = c[0].f || '';
    if (fmt && /^\d{4}-\d{2}-\d{2}$/.test(fmt)) {
      d = fmt;
    } else if (raw.startsWith('Date(')) {
      const p = raw.match(/Date\((\d+),(\d+),(\d+)\)/);
      if (p) d = `${p[1]}-${String(+p[2]+1).padStart(2,'0')}-${String(+p[3]).padStart(2,'0')}`;
    } else if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
      d = raw;
    }
    if (!d) continue;
    const meal = c[1]?.v||'';
    if (meal === 'DAILY TOTAL' || meal === 'üìä TOTAL') continue;
    meals.push({ date: d, meal, food: c[2]?.v||'', cal: Number(c[3]?.v)||0, prot: Number(c[4]?.v)||0 });
  }
  const byDate = {};
  for (const m of meals) {
    if (!byDate[m.date]) byDate[m.date] = { date: m.date, cal: 0, prot: 0, meals: [] };
    byDate[m.date].cal += m.cal;
    byDate[m.date].prot += m.prot;
    byDate[m.date].meals.push(m);
  }
  return Object.values(byDate).sort((a, b) => a.date.localeCompare(b.date));
}

function shortDate(d) {
  try {
    const dt = new Date(d + 'T00:00:00');
    return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  } catch(e) { return d; }
}

// ===== RENDER DASHBOARD =====
function renderDash(data) {
  dailyData = data;
  const avg = (arr, key) => arr.length ? Math.round(arr.reduce((s,d) => s + d[key], 0) / arr.length) : 0;
  const avgCal = avg(data, 'cal'), avgProt = avg(data, 'prot');
  const calHit = data.length ? Math.round(data.filter(d => d.cal <= CAL_TARGET && d.cal > 0).length / data.length * 100) : 0;
  const protHit = data.length ? Math.round(data.filter(d => d.prot >= PROT_TARGET).length / data.length * 100) : 0;

  // Today bar
  const today = new Date().toISOString().split('T')[0];
  const todayData = data.find(d => d.date === today);
  const tCal = todayData?.cal || 0, tProt = todayData?.prot || 0;
  const calPct = Math.min(100, Math.round(tCal / CAL_TARGET * 100));
  const protPct = Math.min(100, Math.round(tProt / PROT_TARGET * 100));
  document.getElementById('todayBar').innerHTML = `
    <div class="today-bar">
      <div style="font-weight:700;font-size:0.85rem;margin-bottom:10px">üìç Today</div>
      <div class="today-row"><span class="label">Calories</span><span class="val ${tCal > CAL_TARGET ? 'bad' : tCal > CAL_TARGET*0.8 ? 'warn' : 'good'}">${tCal.toLocaleString()} / ${CAL_TARGET.toLocaleString()}</span></div>
      <div class="today-mini-bar"><div class="today-mini-fill" style="width:${calPct}%;background:${tCal>CAL_TARGET?'var(--red)':'var(--accent2)'}"></div></div>
      <div class="today-row" style="margin-top:10px"><span class="label">Protein</span><span class="val ${tProt >= PROT_TARGET ? 'good' : 'bad'}">${tProt}g / ${PROT_TARGET}g</span></div>
      <div class="today-mini-bar"><div class="today-mini-fill" style="width:${protPct}%;background:${tProt>=PROT_TARGET?'var(--green)':'var(--orange)'}"></div></div>
    </div>`;

  // Stats
  document.getElementById('dashStats').innerHTML = `
    <div class="stat-card ${avgCal > CAL_TARGET ? 'yellow' : 'green'}"><div class="val">${avgCal.toLocaleString()}</div><div class="lbl">Avg Cal</div></div>
    <div class="stat-card ${avgProt < PROT_TARGET ? 'red' : 'green'}"><div class="val">${avgProt}g</div><div class="lbl">Avg Protein</div></div>
    <div class="stat-card ${calHit >= 50 ? 'green' : 'accent'}"><div class="val">${calHit}%</div><div class="lbl">Cal Hit</div></div>
    <div class="stat-card ${protHit >= 50 ? 'green' : 'red'}"><div class="val">${protHit}%</div><div class="lbl">Prot Hit</div></div>`;

  // Table
  const tbody = document.getElementById('logBody');
  tbody.innerHTML = data.map(d => {
    const cd = d.cal - CAL_TARGET, pd = d.prot - PROT_TARGET;
    return `<tr><td style="font-weight:600">${shortDate(d.date)}</td><td>${d.cal.toLocaleString()}</td><td>${d.prot}g</td>
    <td><span class="badge ${cd>0?'over':'under'}">${cd>0?'+':''}${cd}</span></td></tr>`;
  }).join('');

  // Charts
  Chart.defaults.color = '#71717a';
  Chart.defaults.borderColor = 'rgba(255,255,255,0.04)';
  Chart.defaults.font.family = 'Inter';
  const labels = data.map(d => shortDate(d.date));

  if (window._calChart) window._calChart.destroy();
  if (window._protChart) window._protChart.destroy();

  window._calChart = new Chart(document.getElementById('calChart'), {
    type: 'bar',
    data: { labels, datasets: [
      { label: 'Calories', data: data.map(d=>d.cal), backgroundColor: data.map(d=>d.cal>CAL_TARGET?'rgba(255,107,107,0.7)':'rgba(108,92,231,0.7)'), borderRadius: 5, borderSkipped: false },
      { label: 'Target', data: Array(labels.length).fill(CAL_TARGET), type:'line', borderColor:'rgba(0,206,201,0.7)', borderDash:[5,3], borderWidth:2, pointRadius:0, fill:false }
    ]},
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:false,min:Math.min(800,...data.map(d=>d.cal))-100,grid:{color:'rgba(255,255,255,0.03)'}},x:{grid:{display:false},ticks:{font:{size:10}}}}}
  });

  window._protChart = new Chart(document.getElementById('protChart'), {
    type: 'bar',
    data: { labels, datasets: [
      { label: 'Protein', data: data.map(d=>d.prot), backgroundColor: data.map(d=>d.prot>=PROT_TARGET?'rgba(81,207,102,0.7)':'rgba(255,146,43,0.7)'), borderRadius: 5, borderSkipped: false },
      { label: 'Target', data: Array(labels.length).fill(PROT_TARGET), type:'line', borderColor:'rgba(0,206,201,0.7)', borderDash:[5,3], borderWidth:2, pointRadius:0, fill:false }
    ]},
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:false,min:Math.min(40,...data.map(d=>d.prot))-10,grid:{color:'rgba(255,255,255,0.03)'}},x:{grid:{display:false},ticks:{font:{size:10}}}}}
  });

  // Roadmap
  const roadmapHTML = [
    { wk:'Week 0 ‚Äî Now', dt:'72.4 kg ¬∑ 18.5% BF', ms:'Starting point', cls:'now' },
    { wk:'Week 2', dt:'71.4 kg ¬∑ 17.5% BF', ms:'First visible change', cls:'' },
    { wk:'Week 4', dt:'70.4 kg ¬∑ 16.5% BF', ms:'Clothes fit looser', cls:'' },
    { wk:'Week 6', dt:'69.4 kg ¬∑ 15.5% BF', ms:'Upper abs visible', cls:'' },
    { wk:'Week 8 üèÜ', dt:'68.6 kg ¬∑ 14% BF', ms:'GOAL!', cls:'goal' },
  ].map(r => `<div class="roadmap-item ${r.cls}"><div class="rm-dot"></div><div class="rm-info"><div class="wk">${r.wk}</div><div class="dt">${r.dt}</div></div><div class="rm-ms">${r.ms}</div></div>`).join('');
  document.getElementById('roadmap').innerHTML = roadmapHTML;
  if (document.getElementById('roadmap2')) document.getElementById('roadmap2').innerHTML = roadmapHTML;

  document.getElementById('updated').textContent = new Date().toLocaleString('en-MY', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
}

// ===== UPLOAD / PHOTO SCAN =====
const fileInput = document.getElementById('fileInput');
const fileInputGallery = document.getElementById('fileInputGallery');
fileInputGallery.addEventListener('change', handlePhoto);
fileInput.addEventListener('change', handlePhoto);
async function handlePhoto(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (ev) => {
    const origDataUrl = ev.target.result;
    document.getElementById('uploadBtns').style.display = 'none';
    document.getElementById('previewImg').src = origDataUrl;

    // Compress image before sending (max 800px, JPEG 70%)
    const dataUrl = await new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const MAX = 400;
        let w = img.width, h = img.height;
        if (w > MAX || h > MAX) {
          if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
          else { w = Math.round(w * MAX / h); h = MAX; }
        }
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL('image/jpeg', 0.4));
      };
      img.src = origDataUrl;
    });
    document.getElementById('previewArea').classList.add('show');
    document.getElementById('uploadZone').style.display = 'none';
    document.getElementById('analyzingMsg').style.display = 'block';
    document.getElementById('resultBox').style.display = 'none';
    document.getElementById('editSection').style.display = 'none';

    try {
      const resp = await apiFetch('/analyze', { image: dataUrl }, 45000);
      const data = await resp.json();
      document.getElementById('analyzingMsg').style.display = 'none';

      if (data.ok && data.analysis) {
        const a = data.analysis;
        if (a.raw) {
          document.getElementById('resultBox').style.display = 'block';
          document.getElementById('resultBox').innerHTML = `<h3>üìä Analysis</h3><p style="font-size:0.85rem">${a.raw}</p>`;
        } else {
          lastAnalysis = a;
          editItems = (a.items || []).map(i => ({...i}));
          renderEditItems();
          document.getElementById('editSection').style.display = 'block';
        }
      } else {
        document.getElementById('resultBox').style.display = 'block';
        document.getElementById('resultBox').innerHTML = `<h3>‚ùå Error</h3><p>${data.error || 'Failed'}</p>`;
      }
    } catch(e) {
      document.getElementById('analyzingMsg').style.display = 'none';
      document.getElementById('resultBox').style.display = 'block';
      document.getElementById('resultBox').innerHTML = `<h3>‚ö†Ô∏è API Offline</h3>
        <p style="font-size:0.85rem;margin-bottom:12px">Can't reach AI server. Send to Abi on WhatsApp instead:</p>
        <a href="https://wa.me/${WA_NUMBER}?text=${encodeURIComponent('üì∏ Food photo for calorie scan')}" target="_blank"
           style="display:block;text-align:center;padding:12px;background:linear-gradient(135deg,#25D366,#128C7E);color:#fff;border-radius:10px;text-decoration:none;font-weight:700">
          Send to Abi on WhatsApp
        </a>`;
    }
  };
  reader.readAsDataURL(file);
}

let editItems = [];

function renderEditItems() {
  const list = document.getElementById('itemsList');
  list.innerHTML = editItems.map((item, i) => `
    <div class="edit-item" data-idx="${i}">
      <div class="edit-item-header">
        <input class="edit-item-name" value="${item.name || ''}" onchange="editItems[${i}].name=this.value">
        <button class="edit-item-del" onclick="editItems.splice(${i},1);renderEditItems()">‚úï</button>
      </div>
      <div class="edit-item-macros">
        <div class="macro-field"><label>Wt(g)</label><input type="number" value="${item.weight_g||0}" onchange="editItems[${i}].weight_g=+this.value"></div>
        <div class="macro-field"><label>Cal</label><input type="number" value="${item.calories||0}" onchange="editItems[${i}].calories=+this.value;updateTotals()"></div>
        <div class="macro-field"><label>Prot</label><input type="number" value="${item.protein||0}" onchange="editItems[${i}].protein=+this.value;updateTotals()"></div>
        <div class="macro-field"><label>Carb</label><input type="number" value="${item.carbs||0}" onchange="editItems[${i}].carbs=+this.value;updateTotals()"></div>
        <div class="macro-field"><label>Fat</label><input type="number" value="${item.fat||0}" onchange="editItems[${i}].fat=+this.value;updateTotals()"></div>
      </div>
    </div>`).join('');
  updateTotals();
  // Show recommendation if available
  if (lastAnalysis?.recommendation) {
    document.getElementById('recoBox').style.display = 'block';
    document.getElementById('recoText').textContent = lastAnalysis.recommendation;
  }
}

function updateTotals() {
  const t = editItems.reduce((s, i) => ({ cal: s.cal+(+i.calories||0), prot: s.prot+(+i.protein||0), carb: s.carb+(+i.carbs||0), fat: s.fat+(+i.fat||0) }), { cal:0, prot:0, carb:0, fat:0 });
  document.getElementById('editTotals').innerHTML = `
    <div><div style="font-size:1.4rem;font-weight:800;color:var(--accent2)">${t.cal}</div><div style="font-size:0.6rem;color:var(--text-dim)">CAL</div></div>
    <div><div style="font-size:1.4rem;font-weight:800;color:var(--green)">${t.prot}g</div><div style="font-size:0.6rem;color:var(--text-dim)">PROT</div></div>
    <div><div style="font-size:1.4rem;font-weight:800;color:var(--orange)">${t.carb}g</div><div style="font-size:0.6rem;color:var(--text-dim)">CARB</div></div>
    <div><div style="font-size:1.4rem;font-weight:800;color:var(--yellow)">${t.fat}g</div><div style="font-size:0.6rem;color:var(--text-dim)">FAT</div></div>`;
}

function startManualEntry() {
  const box = document.getElementById('manualEntryBox');
  box.style.display = box.style.display === 'none' ? 'block' : 'none';
  if (box.style.display === 'block') document.getElementById('manualFoodInput').focus();
}

async function analyzeManualText() {
  const text = document.getElementById('manualFoodInput').value.trim();
  if (!text) return;
  document.getElementById('uploadBtns').style.display = 'none';
  document.getElementById('previewArea').classList.add('show');
  document.getElementById('previewImg').src = '';
  document.getElementById('previewImg').style.display = 'none';
  document.getElementById('analyzingMsg').style.display = 'block';
  document.getElementById('resultBox').style.display = 'none';
  document.getElementById('editSection').style.display = 'none';
  try {
    const resp = await apiFetch('/chat', { question: `Estimate calories and macros for this meal. Return JSON only, no explanation. Format: {"items":[{"name":"...","calories":0,"protein":0,"carbs":0,"fat":0}],"recommendation":"..."}

Meal: ${text}` }, 30000);
    const data = await resp.json();
    document.getElementById('analyzingMsg').style.display = 'none';
    if (data.ok && data.reply) {
      try {
        const jsonMatch = data.reply.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          const parsed = JSON.parse(jsonMatch[0]);
          lastAnalysis = parsed;
          editItems = (parsed.items || []).map(i => ({...i}));
          renderEditItems();
          document.getElementById('editSection').style.display = 'block';
          if (parsed.recommendation) {
            document.getElementById('recoBox').style.display = 'block';
            document.getElementById('recoText').textContent = parsed.recommendation;
          }
        } else { throw new Error('no json'); }
      } catch(pe) {
        editItems = [{ name: text, calories: 0, protein: 0, carbs: 0, fat: 0 }];
        renderEditItems();
        document.getElementById('editSection').style.display = 'block';
      }
    } else { throw new Error(data.error || 'Failed'); }
  } catch(e) {
    document.getElementById('analyzingMsg').style.display = 'none';
    editItems = [{ name: text, calories: 0, protein: 0, carbs: 0, fat: 0 }];
    renderEditItems();
    document.getElementById('editSection').style.display = 'block';
  }
}

function skipAIManual() {
  const text = document.getElementById('manualFoodInput').value.trim();
  if (!text) return;
  document.getElementById('uploadBtns').style.display = 'none';
  document.getElementById('previewArea').classList.add('show');
  document.getElementById('previewImg').src = '';
  document.getElementById('previewImg').style.display = 'none';
  document.getElementById('analyzingMsg').style.display = 'none';
  document.getElementById('resultBox').style.display = 'none';
  // Parse comma/newline separated items
  const items = text.split(/[,\n]+/).map(s => s.trim()).filter(Boolean);
  editItems = items.map(name => ({ name, calories: 0, protein: 0, carbs: 0, fat: 0 }));
  renderEditItems();
  document.getElementById('editSection').style.display = 'block';
}

function addItem() {
  editItems.push({ name: 'New item', weight_g: 0, calories: 0, protein: 0, carbs: 0, fat: 0 });
  renderEditItems();
  // Focus the new item name
  setTimeout(() => { const names = document.querySelectorAll('.edit-item-name'); names[names.length-1]?.focus(); }, 50);
}

async function logToSheet() {
  const t = editItems.reduce((s, i) => ({ cal: s.cal+(+i.calories||0), prot: s.prot+(+i.protein||0), carb: s.carb+(+i.carbs||0), fat: s.fat+(+i.fat||0) }), { cal:0, prot:0, carb:0, fat:0 });
  const btn = document.querySelector('#editSection .btn-primary');
  if (btn) { btn.textContent = '‚è≥ Logging...'; btn.disabled = true; }
  try {
    const hr = new Date().getHours();
    const autoMeal = hr < 10 ? 'Breakfast' : hr < 14 ? 'Lunch' : hr < 17 ? 'Snack' : 'Dinner';
    const resp = await apiFetch('/log', { meal: autoMeal, items: editItems }, 20000);
    const data = await resp.json();
    if (data.ok) {
      document.getElementById('editSection').innerHTML = `
        <div class="card" style="margin-top:12px;text-align:center;padding:24px">
          <div style="font-size:2rem;margin-bottom:8px">‚úÖ</div>
          <div style="font-weight:700;margin-bottom:4px">Logged to Google Sheet!</div>
          <div style="color:var(--text-dim);font-size:0.8rem">${t.cal} cal ¬∑ ${t.prot}g protein</div>
        </div>
        <button class="btn btn-secondary" onclick="resetUpload()" style="margin-top:12px">Log Another</button>
        <button class="btn btn-secondary" onclick="document.querySelectorAll('.nav-item')[0].click()" style="margin-top:8px">‚Üê Back to Dashboard</button>`;
      // Refresh dashboard data in background
      try { const d = await fetchData(); renderDash(d); } catch(e) {}
    } else { throw new Error(data.error || 'Failed'); }
  } catch(e) {
    // Fallback to WhatsApp if API fails
    const names = editItems.map(i => i.name).join(' + ');
    const waText = encodeURIComponent(`üìù Log meal: ${names} ‚Äî ${t.cal} cal, ${t.prot}g protein, ${t.carb}g carbs, ${t.fat}g fat`);
    window.open(`https://wa.me/${WA_NUMBER}?text=${waText}`, '_blank');
    document.getElementById('editSection').innerHTML = `
      <div class="card" style="margin-top:12px;text-align:center;padding:24px">
        <div style="font-size:2rem;margin-bottom:8px">‚ö†Ô∏è</div>
        <div style="font-weight:700;margin-bottom:4px">API offline ‚Äî sent to Abi via WhatsApp</div>
        <div style="color:var(--text-dim);font-size:0.8rem">${t.cal} cal ¬∑ ${t.prot}g protein</div>
      </div>
      <button class="btn btn-secondary" onclick="resetUpload()" style="margin-top:12px">Log Another</button>`;
  }
}

function resetUpload() {
  document.getElementById('previewArea').classList.remove('show');
  document.getElementById('uploadBtns').style.display = 'flex';
  document.getElementById('editSection').style.display = 'none';
  document.getElementById('resultBox').style.display = 'none';
  document.getElementById('recoBox').style.display = 'none';
  document.getElementById('previewImg').style.display = '';
  document.getElementById('manualEntryBox').style.display = 'none';
  document.getElementById('manualFoodInput').value = '';
  editItems = [];
  fileInput.value = '';
  fileInputGallery.value = '';
}

// ===== ASK / CHAT =====
function addMsg(text, role) {
  const div = document.createElement('div');
  div.className = `chat-msg ${role}`;
  div.innerHTML = text;
  document.getElementById('chatMsgs').appendChild(div);
  div.scrollIntoView({ behavior: 'smooth' });
}

function askQ(q) {
  document.getElementById('chatInput').value = q;
  sendChat();
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const q = input.value.trim();
  if (!q) return;
  input.value = '';

  addMsg(q, 'user');
  addMsg('<span class="thinking"><span class="spinner"></span> Thinking...</span>', 'ai');

  const today = new Date().toISOString().split('T')[0];
  const td = dailyData.find(d => d.date === today);
  const avgCal = dailyData.length ? Math.round(dailyData.reduce((s,d)=>s+d.cal,0)/dailyData.length) : 0;
  const avgProt = dailyData.length ? Math.round(dailyData.reduce((s,d)=>s+d.prot,0)/dailyData.length) : 0;
  
  const context = `User: David. Goals: 1750 cal/day, 145g protein/day, lose fat 18.5%‚Üí14% BF.
Weight: 72.4kg‚Üí68.6kg target. Today (${today}): ${td ? td.cal+' cal, '+td.prot+'g prot' : 'nothing logged'}.
Week avg: ${avgCal} cal, ${avgProt}g prot over ${dailyData.length} days.
High uric acid ‚Äî limit beef, shellfish, beer, organ meats.
Loves: omakase, wagyu, ramen, duck, satay, nasi lemak. Based in KL, Malaysia.`;

  const msgs = document.getElementById('chatMsgs');

  try {
    const resp = await apiFetch('/chat', { question: q, context });
    const data = await resp.json();
    msgs.removeChild(msgs.lastChild);
    if (data.ok) {
      addMsg(data.reply.replace(/\n/g, '<br>'), 'ai');
    } else {
      addMsg(`‚ùå ${data.error || 'Something went wrong'}`, 'ai');
    }
  } catch(e) {
    msgs.removeChild(msgs.lastChild);
    addMsg(`‚ö†Ô∏è API offline. <a href="https://wa.me/${WA_NUMBER}?text=${encodeURIComponent('üí¨ '+q)}" target="_blank" style="color:var(--accent2)">Ask Abi on WhatsApp instead ‚Üí</a>`, 'ai');
  }
}

// ===== WEIGHT =====
function logWeight() {
  const w = document.getElementById('weightInput').value;
  const waText = encodeURIComponent(`‚öñÔ∏è Weight update: ${w} kg`);
  window.open(`https://wa.me/${WA_NUMBER}?text=${waText}`, '_blank');
}

// ===== INIT =====
(async () => {
  // Try loading cached data first for instant render
  try {
    const cached = localStorage.getItem('dashData');
    if (cached) {
      const cData = JSON.parse(cached);
      if (cData.length > 0) renderDash(cData);
    }
  } catch(e) {}

  // Then fetch fresh data
  try {
    const data = await fetchData();
    console.log('Fetched', data.length, 'days of data');
    if (data.length === 0) throw new Error('No data found in sheet');
    localStorage.setItem('dashData', JSON.stringify(data));
    renderDash(data);
  } catch(e) {
    console.error('Dashboard error:', e);
    // Only show error if we have nothing cached
    if (!localStorage.getItem('dashData')) {
      document.getElementById('pg-dash').innerHTML = `<div class="loading-page">‚ùå ${e.message}<br><button class="btn btn-primary" style="width:auto;margin-top:16px;padding:10px 24px" onclick="location.reload()">Retry</button></div>`;
    }
  }

  // Then resolve API URL in background (non-blocking for page render)
  const FALLBACK_API = 'https://cef04656c80d93f1-60-50-218-160.serveousercontent.com';
  // If served from the API server (same-origin), use relative paths
  if (location.hostname.includes('trycloudflare.com') || location.hostname.includes('serveousercontent.com') || location.hostname === 'localhost') {
    API_URL = '';  // same origin, no CORS needed
  } else {
    API_URL = FALLBACK_API;
  }
  try {
    const gCtrl = new AbortController();
    setTimeout(() => gCtrl.abort(), 3000);
    const r = await fetch(GIST_RAW, { cache: 'no-store', signal: gCtrl.signal });
    const gistUrl = (await r.text()).trim();
    if (gistUrl.startsWith('https://')) API_URL = gistUrl;
  } catch(e) {}
  console.log('API URL:', API_URL);
})();
</script>
</body>
</html>
<!-- deployed 1771587582 -->
